import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
const permissionTypes = {
    notify: 1,
    friends: 2,
    photos: 4,
    audio: 8,
    video: 16,
    offers: 32,
    questions: 64,
    pages: 128,
    links: 256,
    status: 1024,
    notes: 2048,
    messages: 4096,
    wall: 8192,
    ads: 32768,
    offline: 65536,
    docs: 131072,
    groups: 262144,
    notifications: 524288,
    stats: 1048576,
    email: 4194304,
    market: 134217728
};
export class VKLoginProvider extends BaseLoginProvider {
    constructor(clientId, initOptions = {
        fields: 'photo_max,contacts',
        version: '5.131',
    }) {
        super();
        this.clientId = clientId;
        this.initOptions = initOptions;
        this.VK_API_URL = '//vk.com/js/api/openapi.js';
        this.VK_API_GET_USER = 'users.get';
    }
    initialize() {
        return new Promise((resolve, reject) => {
            try {
                this.loadScript(VKLoginProvider.PROVIDER_ID, this.VK_API_URL, () => {
                    VK.init({
                        apiId: this.clientId,
                    });
                    resolve();
                });
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return new Promise((resolve) => this.getLoginStatusInternal(resolve));
    }
    signIn(permissions) {
        if (permissions?.includes('offers')) {
            console.warn('The "offers" permission is outdated.');
        }
        if (permissions?.includes('questions')) {
            console.warn('The "questions" permission is outdated.');
        }
        if (permissions?.includes('messages')) {
            console.warn('The "messages" permission is unavailable for non-standalone applications.');
        }
        const scope = permissions?.reduce((accumulator, current) => {
            const index = Object.keys(permissionTypes).findIndex(pt => pt === current);
            return index > -1 ? accumulator + permissionTypes[current] : 0;
        }, 0);
        return new Promise((resolve) => this.signInInternal(resolve, scope));
    }
    signOut() {
        return new Promise((resolve) => {
            VK.Auth.logout(() => {
                resolve();
            });
        });
    }
    signInInternal(resolve, scope) {
        VK.Auth.login((loginResponse) => {
            if (loginResponse.status === 'connected') {
                this.getUser(loginResponse.session.mid, loginResponse.session.sid, resolve);
            }
        }, scope);
    }
    getUser(userId, token, resolve) {
        VK.Api.call(this.VK_API_GET_USER, {
            user_id: userId,
            fields: this.initOptions.fields,
            v: this.initOptions.version,
        }, (userResponse) => {
            resolve(this.createUser(Object.assign({}, { token }, userResponse.response[0])));
        });
    }
    getLoginStatusInternal(resolve) {
        VK.Auth.getLoginStatus((loginResponse) => {
            if (loginResponse.status === 'connected') {
                this.getUser(loginResponse.session.mid, loginResponse.session.sid, resolve);
            }
        });
    }
    createUser(response) {
        const user = new SocialUser();
        user.id = response.id;
        user.name = `${response.first_name} ${response.last_name}`;
        user.photoUrl = response.photo_max;
        user.authToken = response.token;
        return user;
    }
}
VKLoginProvider.PROVIDER_ID = 'VK';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmstbG9naW4tcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9saWIvc3JjL3Byb3ZpZGVycy92ay1sb2dpbi1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJckQsTUFBTSxlQUFlLEdBQUc7SUFDdEIsTUFBTSxFQUFFLENBQUM7SUFDVCxPQUFPLEVBQUUsQ0FBQztJQUNWLE1BQU0sRUFBRSxDQUFDO0lBQ1QsS0FBSyxFQUFFLENBQUM7SUFDUixLQUFLLEVBQUUsRUFBRTtJQUNULE1BQU0sRUFBRSxFQUFFO0lBQ1YsU0FBUyxFQUFFLEVBQUU7SUFDYixLQUFLLEVBQUUsR0FBRztJQUNWLEtBQUssRUFBRSxHQUFHO0lBQ1YsTUFBTSxFQUFFLElBQUk7SUFDWixLQUFLLEVBQUUsSUFBSTtJQUNYLFFBQVEsRUFBRSxJQUFJO0lBQ2QsSUFBSSxFQUFFLElBQUk7SUFDVixHQUFHLEVBQUUsS0FBSztJQUNWLE9BQU8sRUFBRSxLQUFLO0lBQ2QsSUFBSSxFQUFFLE1BQU07SUFDWixNQUFNLEVBQUUsTUFBTTtJQUNkLGFBQWEsRUFBRSxNQUFNO0lBQ3JCLEtBQUssRUFBRSxPQUFPO0lBQ2QsS0FBSyxFQUFFLE9BQU87SUFDZCxNQUFNLEVBQUUsU0FBUztDQUNsQixDQUFDO0FBRUYsTUFBTSxPQUFPLGVBQWdCLFNBQVEsaUJBQWlCO0lBQ3BELFlBQ1UsUUFBZ0IsRUFDaEIsY0FBYztRQUNwQixNQUFNLEVBQUUsb0JBQW9CO1FBQzVCLE9BQU8sRUFBRSxPQUFPO0tBQ2pCO1FBRUQsS0FBSyxFQUFFLENBQUM7UUFOQSxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ2hCLGdCQUFXLEdBQVgsV0FBVyxDQUdsQjtRQU9jLGVBQVUsR0FBRyw0QkFB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b3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlTG9naW5Qcm92aWRlciB9IGZyb20gJy4uL2VudGl0aWVzL2Jhc2UtbG9naW4tcHJvdmlkZXInO1xuaW1wb3J0IHsgU29jaWFsVXNlciB9IGZyb20gJy4uL2VudGl0aWVzL3NvY2lhbC11c2VyJztcblxuZGVjbGFyZSBsZXQgVks6IGFueTtcblxuY29uc3QgcGVybWlzc2lvblR5cGVzID0ge1xuICBub3RpZnk6IDEsXG4gIGZyaWVuZHM6IDIsXG4gIHBob3RvczogNCxcbiAgYXVkaW86IDgsXG4gIHZpZGVvOiAxNixcbiAgb2ZmZXJzOiAzMixcbiAgcXVlc3Rpb25zOiA2NCxcbiAgcGFnZXM6IDEyOCxcbiAgbGlua3M6IDI1NixcbiAgc3RhdHVzOiAxMDI0LFxuICBub3RlczogMjA0OCxcbiAgbWVzc2FnZXM6IDQwOTYsXG4gIHdhbGw6IDgxOTIsXG4gIGFkczogMzI3NjgsXG4gIG9mZmxpbmU6IDY1NTM2LCBcbiAgZG9jczogMTMxMDcyLFxuICBncm91cHM6IDI2MjE0NCxcbiAgbm90aWZpY2F0aW9uczogNTI0Mjg4LFxuICBzdGF0czogMTA0ODU3NixcbiAgZW1haWw6IDQxOTQzMDQsXG4gIG1hcmtldDogMTM0MjE3NzI4XG59O1xuXG5leHBvcnQgY2xhc3MgVktMb2dpblByb3ZpZGVyIGV4dGVuZHMgQmFzZUxvZ2luUHJvdmlkZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNsaWVudElkOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBpbml0T3B0aW9ucyA9IHtcbiAgICAgIGZpZWxkczogJ3Bob3RvX21heCxjb250YWN0cycsXG4gICAgICB2ZXJzaW9uOiAnNS4xMzEnLFxuICAgIH1cbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgUFJPVklERVJfSUQ6IHN0cmluZyA9ICdWSyc7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBWS19BUElfVVJMID0gJy8vdmsuY29tL2pzL2FwaS9vcGVuYXBpLmpzJztcbiAgcHJpdmF0ZSByZWFkb25seSBWS19BUElfR0VUX1VTRVIgPSAndXNlcnMuZ2V0JztcblxuICBpbml0aWFsaXplKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLmxvYWRTY3JpcHQoXG4gICAgICAgICAgVktMb2dpblByb3ZpZGVyLlBST1ZJREVSX0lELFxuICAgICAgICAgIHRoaXMuVktfQVBJX1VSTCxcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICBWSy5pbml0KHtcbiAgICAgICAgICAgICAgYXBpSWQ6IHRoaXMuY2xpZW50SWQsXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGdldExvZ2luU3RhdHVzKCk6IFByb21pc2U8U29jaWFsVXNlcj4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxTb2NpYWxVc2VyPigocmVzb2x2ZTogKHZhbHVlOiBTb2NpYWxVc2VyKSA9PiB2b2lkKSA9PlxuICAgICAgdGhpcy5nZXRMb2dpblN0YXR1c0ludGVybmFsKHJlc29sdmUpXG4gICAgKTtcbiAgfVxuXG4gIHNpZ25JbihwZXJtaXNzaW9uczogc3RyaW5nW10pOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcbiAgICBpZiAocGVybWlzc2lvbnM/LmluY2x1ZGVzKCdvZmZlcnMnKSkge1xuICAgICAgY29uc29sZS53YXJuKCdUaGUgXCJvZmZlcnNcIiBwZXJtaXNzaW9uIGlzIG91dGRhdGVkLicpO1xuICAgIH1cblxuICAgIGlmIChwZXJtaXNzaW9ucz8uaW5jbHVkZXMoJ3F1ZXN0aW9ucycpKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ1RoZSBcInF1ZXN0aW9uc1wiIHBlcm1pc3Npb24gaXMgb3V0ZGF0ZWQuJyk7XG4gICAgfVxuXG4gICAgaWYgKHBlcm1pc3Npb25zPy5pbmNsdWRlcygnbWVzc2FnZXMnKSkge1xuICAgICAgY29uc29sZS53YXJuKCdUaGUgXCJtZXNzYWdlc1wiIHBlcm1pc3Npb24gaXMgdW5hdmFpbGFibGUgZm9yIG5vbi1zdGFuZGFsb25lIGFwcGxpY2F0aW9ucy4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBzY29wZSA9IHBlcm1pc3Npb25zPy5yZWR1Y2UoKGFjY3VtdWxhdG9yLCBjdXJyZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gT2JqZWN0LmtleXMocGVybWlzc2lvblR5cGVzKS5maW5kSW5kZXgocHQgPT4gcHQgPT09IGN1cnJlbnQpO1xuICAgICAgICByZXR1cm4gaW5kZXggPiAtMSA/IGFjY3VtdWxhdG9yICsgcGVybWlzc2lvblR5cGVzW2N1cnJlbnRdIDogMDtcbiAgICAgIH0sIDApO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFNvY2lhbFVzZXI+KChyZXNvbHZlOiAodmFsdWU6IFNvY2lhbFVzZXIpID0+IHZvaWQpID0+XG4gICAgICB0aGlzLnNpZ25JbkludGVybmFsKHJlc29sdmUsIHNjb3BlKVxuICAgICk7XG4gIH1cblxuICBzaWduT3V0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZTogKHZhbHVlOiB2b2lkIHwgUHJvbWlzZUxpa2U8dm9pZD4pID0+IHZvaWQpID0+IHtcbiAgICAgIFZLLkF1dGgubG9nb3V0KCgpID0+IHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNpZ25JbkludGVybmFsKFxuICAgIHJlc29sdmU6ICh2YWx1ZTogU29jaWFsVXNlcikgPT4gdm9pZCwgXG4gICAgc2NvcGU6YW55XG4gICkge1xuICAgIFZLLkF1dGgubG9naW4oKGxvZ2luUmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgaWYgKGxvZ2luUmVzcG9uc2Uuc3RhdHVzID09PSAnY29ubmVjdGVkJykge1xuICAgICAgICB0aGlzLmdldFVzZXIoXG4gICAgICAgICAgbG9naW5SZXNwb25zZS5zZXNzaW9uLm1pZCxcbiAgICAgICAgICBsb2dpblJlc3BvbnNlLnNlc3Npb24uc2lkLFxuICAgICAgICAgIHJlc29sdmVcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9LCBzY29wZSk7XG4gIH1cblxuICBwcml2YXRlIGdldFVzZXIoXG4gICAgdXNlcklkOiBudW1iZXIsIFxuICAgIHRva2VuOiBzdHJpbmcsIFxuICAgIHJlc29sdmU6ICh2YWx1ZTogU29jaWFsVXNlcikgPT4gdm9pZFxuICApIHtcbiAgICBWSy5BcGkuY2FsbChcbiAgICAgIHRoaXMuVktfQVBJX0dFVF9VU0VSLFxuICAgICAge1xuICAgICAgICB1c2VyX2lkOiB1c2VySWQsXG4gICAgICAgIGZpZWxkczogdGhpcy5pbml0T3B0aW9ucy5maWVsZHMsXG4gICAgICAgIHY6IHRoaXMuaW5pdE9wdGlvbnMudmVyc2lvbixcbiAgICAgIH0sXG4gICAgICAodXNlclJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgcmVzb2x2ZShcbiAgICAgICAgICB0aGlzLmNyZWF0ZVVzZXIoXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCB7IHRva2VuIH0sIHVzZXJSZXNwb25zZS5yZXNwb25zZVswXSlcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TG9naW5TdGF0dXNJbnRlcm5hbChyZXNvbHZlOiAodmFsdWU6IFNvY2lhbFVzZXIpID0+IHZvaWQpIHtcbiAgICBWSy5BdXRoLmdldExvZ2luU3RhdHVzKChsb2dpblJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgIGlmIChsb2dpblJlc3BvbnNlLnN0YXR1cyA9PT0gJ2Nvbm5lY3RlZCcpIHtcbiAgICAgICAgdGhpcy5nZXRVc2VyKFxuICAgICAgICAgIGxvZ2luUmVzcG9uc2Uuc2Vzc2lvbi5taWQsXG4gICAgICAgICAgbG9naW5SZXNwb25zZS5zZXNzaW9uLnNpZCxcbiAgICAgICAgICByZXNvbHZlXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVVzZXIocmVzcG9uc2U6IGFueSk6IFNvY2lhbFVzZXIge1xuICAgIGNvbnN0IHVzZXI6IFNvY2lhbFVzZXIgPSBuZXcgU29jaWFsVXNlcigpO1xuICAgIHVzZXIuaWQgPSByZXNwb25zZS5pZDtcbiAgICB1c2VyLm5hbWUgPSBgJHtyZXNwb25zZS5maXJzdF9uYW1lfSAke3Jlc3BvbnNlLmxhc3RfbmFtZX1gO1xuICAgIHVzZXIucGhvdG9VcmwgPSByZXNwb25zZS5waG90b19tYXg7XG4gICAgdXNlci5hdXRoVG9rZW4gPSByZXNwb25zZS50b2tlbjtcbiAgICByZXR1cm4gdXNlcjtcbiAgfVxufVxuIl19